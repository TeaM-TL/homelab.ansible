---
- name: Disable root login over SSH
  hosts: all:!tiny:!proxmox
  gather_facts: false
  user: root

  vars:
    user: nc

  tasks:
  - name: import secrets
    include_vars:
      file: "~/0/vault/secrets.yml"

  - name: Add user
    user:
      name: "{{ user }}"
      password: "{{ nc_password_hash }}"
      groups: wheel

  - name: Add authorized key
    authorized_key:
      user: "{{ user }}"
      key: "{{ id_ed25519_pub }}"

  - name: Allow 'wheel' group to have passwordless sudo
    lineinfile:
      dest: /etc/sudoers
      state: present
      regexp: '^%wheel'
      line: '%wheel ALL=(ALL) NOPASSWD: ALL'
      validate: 'visudo -cf %s'


- name: Debian-specific tasks
  hosts: proxmox
  user: root
  gather_facts: false
  tags: proxmox

  vars:
    user: nc

  tasks:
  - name: import secrets
    include_vars:
      file: "~/0/vault/secrets.yml"

  - name: install sudo
    apt:
      name: sudo
      state: present

  - name: Add user
    user:
      name: "{{ user }}"
      password: "{{ nc_password_hash }}"
      groups: sudo

  - name: Add authorized key
    authorized_key:
      user: "{{ user }}"
      key: "{{ id_ed25519_pub }}"

  - name: Allow 'sudo' group to have passwordless sudo
    lineinfile:
      dest: /etc/sudoers
      state: present
      regexp: '^%sudo'
      line: '%sudo ALL=(ALL) NOPASSWD: ALL'
      validate: 'visudo -cf %s'

- name: Log in as new user to disable root
  hosts: all:!tiny
  user: "{{ user }}"
  gather_facts: false
  become: yes

  tasks:
  - name: Disable root login over SSH
    lineinfile: dest=/etc/ssh/sshd_config regexp="^PermitRootLogin" line="PermitRootLogin no" state=present
    notify:
      - restart sshd

  - name: Disable password login
    lineinfile: dest=/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present
    notify:
      - restart sshd

  handlers:
  - name: restart sshd
    service:
      name: sshd
      state: restarted
